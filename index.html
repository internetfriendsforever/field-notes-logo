<title>Field Notes interactive logo</title>

<style>
  .container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  #logo {
    width: 100%;
    height: 100%;
  }
</style>

<div class="container">
  <svg id="logo" version='1.1' viewBox='0 0 640 480'>
    <g class='letters'>
     	<g id='F'>
     		<polygon points='143.4,126.3 143.4,131.8 148.9,131.8 197,83.7 197,78.2 191.5,78.2 143.4,126.3'/>
     		<polygon points='88.9,140.1 142.6,140.1 142.6,132.6 88.9,132.6 88.9,140.1'/>
     		<polygon points='143.4,132.6 143.4,186.3 150.8,186.3 150.8,140.1 197,140.1 197,132.6 143.4,132.6'/>
     	</g>
     	<g id='i'>
     		<polygon points='223.8,159.5 245.1,138.2 245.1,132.6 239.5,132.6 218.3,153.9 218.3,159.5 223.8,159.5'/>
     		<polygon points='225.7,240.8 225.7,187.1 218.3,187.1 218.3,240.8 225.7,240.8'/>
     	</g>
     	<g id='e'>
     		<polygon points='293.2,126.3 293.2,131.8 298.7,131.8 339.4,91 339.4,131.8 346.8,131.8 346.8,78.2 341.3,78.2
     			293.2,126.3'/>
     		<polygon points='341.3,186.3 346.8,186.3 346.8,180.7 306,140.1 346.8,140.1 346.8,132.6 293.2,132.6 293.2,138.2
     			341.3,186.3'/>
     	</g>
     	<g id='l'>
     		<polygon points='375.5,131.8 375.5,78.2 368.1,78.2 368.1,131.8 375.5,131.8'/>
     		<polygon points='421.7,178.8 375.5,178.8 375.5,132.6 368.1,132.6 368.1,186.3 421.7,186.3 421.7,178.8'/>
     	</g>
     	<g id='d'>
     		<polygon points='545.5,186.3 551.1,186.3 551.1,180.7 503,132.6 497.4,132.6 497.4,138.2 545.5,186.3'/>
     		<polygon points='489.2,132.6 489.2,186.3 496.6,186.3 496.6,132.6 489.2,132.6'/>
     		<polygon points='543.6,187.1 543.6,233.3 497.4,233.3 497.4,240.8 551.1,240.8 551.1,187.1 543.6,187.1'/>
     		<polygon points='489.2,187.1 489.2,240.8 496.6,240.8 496.6,187.1 489.2,187.1'/>
     	</g>

     <g id='N'>
     	<polygon points='67.2,239.2 61.7,239.2 61.7,292.9 69.1,292.9 69.1,252.1 109.8,292.9 115.3,292.9 115.3,287.3
     		67.2,239.2'/>
     	<polygon points='162.3,239.2 162.3,292.9 169.8,292.9 169.8,239.2 162.3,239.2'/>
     	<polygon points='164.2,347.4 169.8,347.4 169.8,293.7 162.3,293.7 162.3,334.5 121.7,293.7 116.1,293.7 116.1,299.3
     		164.2,347.4'/>
     	<polygon points='69.1,347.4 69.1,293.7 61.7,293.7 61.7,347.4 69.1,347.4'/>
     </g>
    	<g id='o'>
    		<polygon points='251.1,293.7 245.5,293.7 245.5,299.3 293.6,347.4 299.2,347.4 299.2,341.8 251.1,293.7'/>
    		<polygon points='191,341.8 191,347.4 196.6,347.4 244.7,299.3 244.7,293.7 239.1,293.7 191,341.8'/>
    		<polygon points='239.1,401.8 244.7,401.8 244.7,396.3 196.6,348.2 191,348.2 191,353.7 239.1,401.8'/>
    		<polygon points='299.2,353.7 299.2,348.2 293.6,348.2 245.5,396.3 245.5,401.8 251.1,401.8 299.2,353.7'/>
    	</g>
    	<g id='t'>
    		<polygon points='428.5,292.9 428.5,285.4 382.3,285.4 382.3,239.2 374.9,239.2 374.9,292.9 428.5,292.9'/>
    		<polygon points='320.4,292.9 374.1,292.9 374.1,285.4 320.4,285.4 320.4,292.9'/>
    		<polygon points='423,347.4 428.5,347.4 428.5,341.8 380.4,293.7 374.9,293.7 374.9,299.3 423,347.4'/>
    	</g>
    	<g id='e2'>
    		<polygon points='449.8,341.8 449.8,347.4 455.3,347.4 496,306.6 496,347.4 503.4,347.4 503.4,293.7 497.9,293.7
    			449.8,341.8'/>
    		<polygon points='497.9,401.8 503.4,401.8 503.4,396.3 462.6,355.6 503.4,355.6 503.4,348.2 449.8,348.2 449.8,353.7
    			497.9,401.8'/>
    	</g>
    	<g id='s'>
    		<polygon points='578.3,285.4 524.7,285.4 524.7,292.9 578.3,292.9 578.3,285.4'/>
    		<polygon points='530.2,293.7 524.7,293.7 524.7,299.3 565.5,339.9 524.7,339.9 524.7,347.4 578.3,347.4 578.3,341.8
    			530.2,293.7'/>
    	</g>
    </g>

    <line class='mouse' stroke='black' x1='0' y1='0' x2='0' y2='0' />
    <circle class='debug' cx='0' cy='0' r='2' fill='white' />
  </svg>
</div>

<script src="lineMath.js"></script>

<script>
  NodeList.prototype.map = Array.prototype.map
  NodeList.prototype.forEach = Array.prototype.forEach

  const logo = document.querySelector('#logo')
  const polygons = logo.querySelectorAll('polygon')
  const mouse = logo.querySelector('.mouse')
  const letters = logo.querySelector('.letters')

  const shapes = polygons.map(polygon => {
    const points = polygon.points
    const modified = Array.prototype.slice.call(points, 0, -1)
    const string = modified.map(point => [point.x, point.y].join()).join(' ')

    polygon.setAttribute('points', string)

    return {
      polygon: polygon,
      centroid: getPolygonCentroid(polygon),
      angle: 0,
      position: { x: 0, y: 0 },
      velocity: {
        angle: 0,
        position: { x: 0, y: 0 }
      }
    }
  })

  const prev = logo.createSVGPoint()
  const current = logo.createSVGPoint()

  // TODO: Change to render loop:
  logo.addEventListener('mousemove', e => {
    current.x = e.clientX
    current.y = e.clientY

    const p1 = prev.matrixTransform(logo.getScreenCTM().inverse())
    const p2 = current.matrixTransform(logo.getScreenCTM().inverse())

    const mouseLine = [[p1.x, p1.y], [p2.x, p2.y]]

    mouse.setAttribute('x1', p1.x)
    mouse.setAttribute('y1', p1.y)
    mouse.setAttribute('x2', p2.x)
    mouse.setAttribute('y2', p2.y)

    prev.x = current.x
    prev.y = current.y

    shapes.forEach(shape => {
      // if (distance(shape.centroid, p2) < 100) {
        const mouseLength = lineLength(mouseLine)
        const mouseAngle = lineAngle(mouseLine)
        const polygon = shape.polygon
        const points = polygon.points
        const relativeMatrix = getMatrixFromElement(letters, polygon)

        Array(points.length).fill().forEach((v, i) => {
          const p1 = points[i].matrixTransform(relativeMatrix)
          const p2 = points[(i + 1) % points.length].matrixTransform(relativeMatrix)
          const shapeLine = [[p1.x, p1.y], [p2.x, p2.y]]

          if (linesIntersect(mouseLine, shapeLine)) {
            shape.polygon.style.fill = `hsl(${Math.random() * 255}, 100%, 50%)`
            shape.velocity.angle += mouseLength * 0.5
            shape.velocity.position.x += Math.cos(mouseAngle) * mouseLength * 0.5
            shape.velocity.position.y += Math.sin(mouseAngle) * mouseLength * 0.5
          }
        })
      // }
    })
  })

  function update (time) {
    shapes.forEach(shape => {
      shape.angle += shape.velocity.angle
      shape.position.x += shape.velocity.position.x
      shape.position.y += shape.velocity.position.y

      shape.angle *= 0.92
      shape.position.x *= 0.92
      shape.position.y *= 0.92

      shape.velocity.angle *= 0.99
      shape.velocity.position.x *= 0.99
      shape.velocity.position.y *= 0.99
    })
  }

  function render (time) {
    shapes.forEach(shape => {
      const { angle, position, centroid } = shape

      const transforms = [
        `rotate(${angle} ${centroid.x + position.x} ${centroid.y + position.y})`,
        `translate(${position.x} ${position.y})`
      ]

      shape.polygon.setAttribute('transform', transforms.join(' '))
    })
  }

  function tick (time = 0) {
    update(time)
    render(time)
    window.requestAnimationFrame(tick)
  }

  tick()

  function sum (arr) {
    return arr.reduce((acc, val) => acc + val, 0)
  }

  function average (arr) {
    return sum(arr) / arr.length
  }

  function distance (a, b) {
    return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2))
  }

  function getPolygonCentroid (polygon) {
    const centroid = logo.createSVGPoint()
    const points = polygon.points
    centroid.x = average(Array.prototype.map.call(points, point => point.x))
    centroid.y = average(Array.prototype.map.call(points, point => point.y))
    return centroid
  }

  function getMatrixFromElement (from, to) {
    return from.getCTM().inverse().multiply(to.getCTM())
  }
</script>
